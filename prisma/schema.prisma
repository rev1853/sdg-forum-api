// ---------------------------------------------------------
// Prisma setup
// ---------------------------------------------------------
generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// Enums
// ---------------------------------------------------------
enum ThreadStatus {
    ACTIVE
    REMOVED
}

enum InteractionType {
    LIKE
    REPOST
}

// Optional: if you want to standardize report reasons, switch reasonCode to this
// enum ReasonCode {
//   SPAM
//   ABUSE
//   OFFTOPIC
//   COPYRIGHT
//   OTHER
// }

// ---------------------------------------------------------
// Models
// ---------------------------------------------------------

model User {
    id              String   @id @default(cuid())
    email           String   @unique
    username        String   @unique
    name            String?
    password_hash   String
    profile_picture String? // URL
    created_at      DateTime @default(now())

    google_id      String? @unique
    google_email   String? @unique
    google_picture String?

    // relations
    threads              Thread[]             @relation("ThreadAuthor")
    interactions         Interaction[]
    reportsFiled         Report[]             @relation("ReportReporter")
    resetTokens          PasswordResetToken[]
    chatGroupMemberships ChatGroupMember[]
    chatMessages         ChatMessage[]

    @@index([username])
    @@index([created_at])
}

model Category {
    id         String   @id @default(cuid())
    name       String   @unique
    sdg_number Int // (1..17 ideally; enforce in app or with DB CHECK if needed)
    created_at DateTime @default(now())

    threads           ThreadCategory[]
    ChatGroupCategory ChatGroupCategory[]

    @@index([sdg_number])
    @@index([created_at])
}

model Thread {
    id               String       @id @default(cuid())
    author_id        String
    parent_thread_id String?
    title            String
    body             String       @db.Text
    image            String?
    tags             Json         @default("[]")
    status           ThreadStatus @default(ACTIVE)
    review_score     Float        @default(0)
    created_at       DateTime     @default(now())
    updated_at       DateTime     @updatedAt

    author       User             @relation("ThreadAuthor", fields: [author_id], references: [id], onDelete: Cascade)
    parent       Thread?          @relation("ThreadReplies", fields: [parent_thread_id], references: [id], onDelete: Cascade)
    replies      Thread[]         @relation("ThreadReplies")
    categories   ThreadCategory[]
    interactions Interaction[]
    reports      Report[]         @relation("ThreadReports")

    @@index([author_id])
    @@index([parent_thread_id])
    @@index([status])
    @@index([created_at])
}

model ThreadCategory {
    thread_id   String
    category_id String

    thread   Thread   @relation(fields: [thread_id], references: [id], onDelete: Cascade)
    category Category @relation(fields: [category_id], references: [id], onDelete: Cascade)

    @@id([thread_id, category_id])
    @@index([category_id])
}

model Interaction {
    id         String          @id @default(cuid())
    thread_id  String
    user_id    String
    type       InteractionType
    created_at DateTime        @default(now())

    thread Thread @relation(fields: [thread_id], references: [id], onDelete: Cascade)
    user   User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

    // One interaction type per user per thread (e.g., one LIKE)
    @@unique([thread_id, user_id, type])
    @@index([user_id])
    @@index([type])
    @@index([created_at])
}

model Report {
    id          String   @id @default(cuid())
    thread_id   String
    reporter_id String
    reason_code String // or switch to enum ReasonCode
    message     String?
    created_at  DateTime @default(now())

    reporter User   @relation("ReportReporter", fields: [reporter_id], references: [id], onDelete: Cascade)
    thread   Thread @relation("ThreadReports", fields: [thread_id], references: [id], onDelete: Cascade)

    @@index([thread_id])
    @@index([reporter_id])
    @@index([created_at])
}

model PasswordResetToken {
    id         String    @id @default(cuid())
    user_id    String
    token_hash String    @unique
    expires_at DateTime
    used_at    DateTime?
    created_at DateTime  @default(now())

    user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

    @@index([user_id])
    @@index([expires_at])
}

enum ChatGroupRole {
    OWNER
    MEMBER
}

model ChatGroup {
    id         String   @id @default(cuid())
    name       String
    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    categories ChatGroupCategory[]
    members    ChatGroupMember[]
    messages   ChatMessage[]

    @@index([created_at])
}

model ChatGroupCategory {
    group_id    String
    category_id String

    group    ChatGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)
    category Category  @relation(fields: [category_id], references: [id], onDelete: Cascade)

    @@id([group_id, category_id])
    @@index([category_id])
}

model ChatGroupMember {
    group_id  String
    user_id   String
    role      ChatGroupRole @default(MEMBER)
    joined_at DateTime      @default(now())
    left_at   DateTime?

    group ChatGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)
    user  User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

    @@id([group_id, user_id])
    @@index([user_id])
    @@index([role])
}

model ChatMessage {
    id          String   @id
    group_id    String
    user_id     String
    body        String
    reply_to_id String?
    created_at  DateTime @default(now())

    group    ChatGroup     @relation(fields: [group_id], references: [id], onDelete: Cascade)
    user     User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
    reply_to ChatMessage?  @relation("ChatMessageReplies", fields: [reply_to_id], references: [id])
    replies  ChatMessage[] @relation("ChatMessageReplies")

    @@index([group_id, created_at])
    @@index([reply_to_id])
}
